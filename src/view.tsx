import React, { memo, useEffect, useState } from "react";
import { RESY_ID } from "./static";
import { mapToObject } from "./utils";
import {
  getLatestStateMap, viewStoresToLatestState, initialStateHandle, mountedHandle,
} from "./viewReduce";
import type { PrimitiveState, MapStateToProps, Store, PS, Stores } from "./model";

/**
 * è‡ªåŠ¨memoä¸SCUçš„é«˜é˜¶HOC
 * @description å®ƒä¼šè‡ªåŠ¨åŒ–è§„é¿ç»„ä»¶é¢å¤–å¤šä½™çš„re-render
 *
 * @return (stores?:Store<S>|Stores<S>)=>React.MemoExoticComponent<(props:P)=>JSX.Element>
 *          â¡ ğŸ‘‰ @param stores: store or stores`s store is generated by createStore();
 * @param Comp è¢«åŒ…è£¹çš„ç»„ä»¶
 * @param equal æ˜¯å¦ç›¸ç­‰è‡ªå®šä¹‰å‡½æ•°
 */
export function view<P extends PrimitiveState = {}, S extends PrimitiveState = {}>(
  // anyç”¨äºå…¼å®¹æŸäº›HOCå¯¼è‡´çš„ç±»å‹ä¸åˆä¸€é—®é¢˜ï¼Œæ¯”å¦‚withRouter(ä½ç‰ˆæœ¬çš„react-routerè¿˜æ˜¯å­˜åœ¨è¯¥HOC)
  // tslint:disable-next-line:variable-name
  Comp: React.ComponentType<MapStateToProps<S, P> | any>,
  equal?: (next: PS<P, S>, prev: PS<P, S>) => boolean,
) {
  return (stores?: Store<S> | Stores<S>) => memo((props: P) => {
    /** éœ€è¦å°†innerUseStateMapSetä¸stateMapæ”¾åœ¨å†…éƒ¨æ‰§è¡Œï¼Œè¿™æ ·æ¯æ¬¡æ›´æ–°çš„æ—¶å€™å¯ä»¥å¾—åˆ°æœ€æ–°çš„æ•°æ®å¼•ç”¨ä¸æ•°æ®stateMap */
    // å¼•ç”¨æ•°æ®çš„ä»£ç†Set
    const innerUseStateMapSet: Set<keyof S> | Map<keyof Stores<S>, Set<keyof S>> =
        !stores || (stores as Store<S>)[RESY_ID as keyof S] ? new Set() : new Map();
    
    /**
     * @description ç»™stateæ•°æ®åšä¸€ä¸ªä»£ç†ï¼Œä»è€Œè®©å…¶çŸ¥æ™“Compç»„ä»¶å†…éƒ¨ä½¿ç”¨äº†å“ªäº›æ•°æ®ï¼
     * æ°å·§ç”±äºè¿™é‡Œçš„proxyä»£ç†ï¼Œå¯¼è‡´åœ¨æŒ‚è½½å±æ€§æ•°æ®çš„æ—¶å€™ä¸èƒ½ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ï¼Œ
     * æ‰©å±•è¿ç®—ç¬¦...ä¼šè¯»å–æ‰€æœ‰çš„å±æ€§æ•°æ®ï¼Œå¯¼è‡´å†…éƒ¨å…³è”ä½¿ç”¨æ•°æ®å±æ€§å¤±å»å‡†ç¡®æ€§
     * æ‰€ä»¥åªèƒ½æŒ‚è½½åˆ°ä¸€ä¸ªé›†ä¸­çš„å±æ€§ä¸Šï¼Œè¿™é‡Œé€‰æ‹©æ¥propsçš„stateå±æ€§ä¸Š
     *
     * be careful: stateæ˜¯ä¸€ä¸ªproxyï¼Œè¿™é‡Œå¦‚æœå¤–éƒ¨æ•°æ®å¯¹è±¡å°†stateä½œä¸ºåŸå‹é“¾ç»§æ‰¿å°†æ˜¯æ— æ•ˆç»§æ‰¿
     */
    const [state, setState] = useState<S | { [key in keyof Stores<S>]: S }>(() => initialStateHandle(
      innerUseStateMapSet,
      stores,
    ));
    
    // eslint-disable-next-line react-hooks/exhaustive-deps
    useEffect(() => mountedHandle(innerUseStateMapSet, state, setState, props, stores, equal), []);
    
    return <Comp {...props} state={state}/>;
  }, equal ? (prevProps: P, nextProps: P) => {
    // propsä¸stateçš„å˜åŒ–å¯èƒ½å­˜åœ¨åŒæ—¶å˜åŒ–çš„æƒ…å†µï¼Œä½†ä¸å½±å“equalçš„æ‰§è¡Œ
    const latestState = stores
      ? (stores as Store<S>)[RESY_ID as keyof S]
        ? mapToObject(getLatestStateMap(stores as Store<S>))
        : viewStoresToLatestState(stores)
      : ({} as S);
    return equal(
      { props: nextProps, state: latestState },
      { props: prevProps, state: latestState },
    );
  } : undefined);
}
