<div align="center">
<img src="./resy-logo.svg" alt="resy">
<h3>react state manager</h3>
<h4>Support React Native„ÄÅMini Apps</h4>

[![GitHub license](https://img.shields.io/github/license/lsbFlying/resy?style=flat-square)](https://github.com/lsbFlying/resy/blob/master/LICENSE)
[![GitHub Workflow Status](https://img.shields.io/github/actions/workflow/status/lsbFlying/resy/test.yml?branch=master&color=blue&style=flat-square)](https://github.com/lsbFlying/resy/actions/workflows/test.yml)
[![Codecov](https://img.shields.io/codecov/c/github/lsbFlying/resy?style=flat-square)](https://codecov.io/gh/lsbFlying/resy)
[![npm type definitions](https://img.shields.io/npm/types/typescript?color=orange&style=flat-square)](https://github.com/lsbFlying/resy/blob/master/src/index.ts)
[![npm bundle size](https://img.shields.io/bundlephobia/minzip/resy?color=brightgreen&style=flat-square)](https://bundlephobia.com/result?p=resy)
[![react](https://img.shields.io/badge/React-%3E%3D16.8.0-green.svg?style=flat-square)](https://img.shields.io/badge/React-%3E%3D16.0.0-green.svg?style=flat-square)
[![npm](https://img.shields.io/npm/v/resy?color=blue&style=flat-square)](https://www.npmjs.com/package/resy)

</div>

### Features
- üòé Easy!!!
- üòé Support for class and hook
- üòé Better performance optimization

### Install
```sh
npm i resy

# yarn add resy
# pnpm add resy
```

### Usage
```tsx
import { createStore, useStore, ComponentWithStore } from "resy";

const store = createStore({ count: 0 });

// for hook component
function App() {
  const { count } = useStore(store);
  // or
  // const { count, text } = store.useStore();
  return (
    <>
      {count}
      <button onClick={() => store.count++}>+</button>
    </>
  );
}

// for class component
class AppClass extends ComponentWithStore {
  
  store = this.connectStore(store);
  
  render() {
    const { count } = this.store;
    return (
      <>
        {count}
        <button onClick={() => this.store.count++}>+</button>
      </>
    );
  }
}
```

[![Edit on CodeSandbox](https://codesandbox.io/static/img/play-codesandbox.svg)](https://codesandbox.io/s/resy-igo13u?file=/src/App.js)

## Basic API
resy requires the version of React v >= 16.8

| API             | Description                                                  |
|-----------------|--------------------------------------------------------------|
| createStore     | Create a store container for state                           |
| useStore        | Use state from the store container generated by createStore  |
| setState        | Update data                                                  |
| syncUpdate      | Synchronously update data                                    |

### Detailed introduction of api

<details>
<summary>
createStore
</summary>

##### the store returned by createStore can be shared globally
```tsx
const demoStore1 = createStore({
  count: 0,
  text: "hello",
});
```

##### paradigm type
```tsx
type DemoStateType = { count: number; text?: number | string };
// In this way, the type of text can be
// more accurately identified as number or string or undefined
const demoStore2 = createStore<DemoStateType>({
  count: 0,
});
```

##### function return
```tsx
// This is a very important feature for retrieving the latest time or other data.
const demoStore3 = createStore(() => {
  return {
    count: 0,
    time: Date.now(),
  };
});
```

##### initial function attribute
```tsx
const demoStore4 = createStore({
  count: 0,
  increase() {
    // this point store object, as follows example
    // The updates and usage of these APIs will be detailed in subsequent chapters
    this.count++;
    // this.setState({ count: this.count + 1 });
    // this.restore();
    
    // demoStore4.count++;
    // demoStore4.setState({ count: demoStore3.count + 1 });
  },
});
```

##### general use
```tsx
import { createStore } from "resy";

type StateType = {
  count: number;
  text: string;
  info: { name: string };
  ageList: { age: number }[];
  increase(): void;
  inputValue?: string;
};

// The generated store can be shared globally
const store = createStore<StateType>({
  count: 0,
  text: "hello",
  info: { name: "Jack" },
  ageList: [{age: 12}, { age: 16 }],
  increase() {
    this.count++;
  },
});
```

##### createStore options item - unmountRestore
```tsx
// Store such as login and theme can set unmountRestore to false
// so that it will not be reset globally.
const loginStore = createStore<{ userName: string; userId: number }>(
  {
    userName: "wenmu",
    userId: 0,
  },
  {
    unmountRestore: false,
  },
);
const themeStore = createStore<{ themeStyle: "dark" | "light" }>(
  {
    themeStyle: "dark",
  },
  {
    unmountRestore: false,
  },
);
```
</details>

<details>
<summary>useStore</summary>

##### deconstruction usage mode
```tsx
import { useStore } from "resy";

function App() {
  const { count, text } = useStore(store);
  // or
  // const { count, text } = store.useStore();
  
  return (
    <>
      <p>{count}</p>
      <p>{text}</p>
    </>
  );
}
```

##### direct read usage mode
```tsx
import { useStore } from "resy";

function App() {
  const state = useStore(store);
  
  return (
    <>
      <p>{state.count}</p>
      <p>{state.text}</p>
    </>
  );
}
```

##### The method of deconstructing StoreUtils
<details>
<summary>
setState, syncUpdate, restore, subscribe,
</summary>
the four methods of StoreUtils are setState, syncUpdate,
restore and subscribe, it can be deconstructed and used directly
from useStore, but store itself has these four methods,
which are described in more detail in the following sections.
</details>

```tsx
import { useStore } from "resy";

function App() {
  const {
    count, text,
    // The use of these api will be described in detail later.
    setState, syncUpdate, restore, subscribe,
  } = useStore(store);
  
  return (
    <>
      <p>{count}</p>
      <p>{text}</p>
    </>
  );
}
```

##### direct assignment update
```tsx
import { useStore } from "resy";

function App() {
  const { count, text } = useStore(store);
  
  // Updates can be assigned directly
  function btn2() {
    store.count++;
    store.text = "456asd";
  }
  
  return (
    <>
      <p>{count}</p>
      <p>{text}</p>
    </>
  );
}
```

</details>

<details>
<summary>
Invalid update
</summary>

```tsx
import { useStore } from "resy";

function App() {
  const {
    info: { name }, ageList, inputValue,
  } = useStore(store);
  
  function btn2() {
    // store.info.name = "Jack";   // Invalid update
    // store.ageList[0] = { age: 7 };   // Invalid update
    
    store.info = { name: "Jack" }; // Effective update
    store.ageList = [{age: 7}];   // Effective update
  }
  
  return (
    <>
      <p>{name}</p>
      {ageList.map(item => `AgeÔºö${item}`)}<br/>
      <button onClick={btn2}>btn2</button>
    </>
  );
}
```

</details>

<details>
<summary>setState</summary>

```tsx
import { useStore } from "resy";

function App() {
  const { count, text } = useStore(store);
  
  return (
    <>
      <div>{count}</div>
      <div>{text}</div>
      <button
        onClick={() => {
          store.setState({
            text: "demo-setState",
            count: count + 1,
          });
        }}
      >
        btn
      </button>
    </>
  );
}
```

##### setState's callback
```tsx
import { useStore } from "resy";

function App() {
  const { text } = useStore(store);
  
  return (
    <button
      onClick={() => {
        store.setState({
          text: "cur-text",
        }, nextState => {
          console.log(nextState.text === "cur-text"); // true
        });
      }}
    >
      {text}
    </button>
  );
}
```

##### parameters of callback for setState
the difference between the callback of setState
and the callback of this.setState of class components

* reading this.state in the callback function of this.setState
  in the class component obtains the latest data in the current round of updates.

```tsx
import { Component } from "react";

class TestClassX extends Component {
  constructor() {
    super();
    this.state = { count: 0, text: "class-x" };
  }
  
  render() {
    const { count, text } = this.state;
    return (
      <>
        {count},{text}
        <button
          onClick={() => {
            this.setState({
              text: "Try",
            }, () => {
              console.log(this.state.count === 9);  // true
            });
            this.setState({ count: 9 });
          }}
        >
          btn
        </button>
      </>
    );
  }
}
```  

* however, the nextState of the callback function
  of resy's setState is the latest data in the current synchronization phase,
  but it does not belong to the latest data after the final round of updates.
```tsx
import { useStore, createStore } from "resy";

const store = createStore({count: 0, text: "hello"});

function App() {
  const { text } = useStore(store);
  
  return (
    <button
      onClick={() => {
        store.setState({
          text: "cur-text",
        }, nextState => {
          console.log(nextState.text === "cur-text"); // true
          console.log(nextState.count === 0); // true
          console.log(store.count === 9); // true
        });
        store.setState({count: 9});
      }}
    >
      {text}
    </button>
  );
}
```

##### parameters of the function type of setState
```tsx
import { useStore } from "resy";

const store = createStore({count: 0, text: "hello"});

function App() {
  const { count, text } = useStore(store);
  
  function btnClick1() {
    store.setState(() => {
      // Returns the object that will eventually be updated
      // through the calculation of complex business logic
      return {
        count: count + 1,
        text: "B-Way-setState-with-function",
      };
    });
  }
  
  function btnClick2() {
    store.count = 9;
    // The prevState parameter of the function
    store.setState(prevState => {
      console.log(prevState.count === 9);  // true
      console.log(store.count === 9);  // true
      return {
        text: "ok",
      };
    });
  }
  
  return (
    <>
      <div>{count}</div>
      <div>{text}</div>
      <button onClick={btnClick1}>btn-1</button>
      <button onClick={btnClick2}>btn-2</button>
    </>
  );
}
```
</details>

<details>
<summary>syncUpdate</summary>

```tsx
import { useStore, syncUpdate } from "resy";

function App() {
  const { inputValue } = useStore(store);
  
  function inputChange(event: React.ChangeEvent<HTMLInputElement>) {
    store.syncUpdate({
      inputValue: event.target.value,
    });
    // @example B
    // store.syncUpdate(prevState => {
    //   // prevState is same as setState's prevState.
    //   return {
    //     inputValue: event.target.value,
    //   };
    // });
  }
  
  return (
    <input value={inputValue} onChange={inputChange}/>
  );
}
```
</details>

<details>
<summary>fine-grained of update</summary>

```tsx
import { useStore } from "resy";

// changes in the state of count data will not cause re-render in Text
function Text() {
  const { text } = useStore(store);
  return <p>{text}</p>;
}

// changes in the state of text data will not cause re-render in Count
function Count() {
  const { count } = useStore(store);
  return <p>{count}</p>;
}

function App() {
  const { increase, name } = useStore(store);
  
  return (
    <>
      <Text/>
      <Count/>
      <div>{name}</div>
      <button onClick={() => { store.name = "app"; }}>btn-name</button>
      <button onClick={increase}>btn+</button>
      <button onClick={() => { store.count-- }}>btn-</button>
    </>
  );
}
```
</details>

## Advanced API
| API             | Description                                                  |
|-----------------|--------------------------------------------------------------|
| useConciseState | Concise version of useState                                  |
| subscribe       | Subscribe for changes in store data generated by createStore |
| restore         | Reset data of store, with re-render effect                   |
| setOptions      | Set the options parameter of createStore                     |

### Detailed introduction of api

<details>
<summary>useConciseState</summary>

```tsx
import { useConciseState } from "resy";

const initialState = {
  count: 123,
  text: "hello-consice",
};

function App() {
  const { count, text, store, setState } = useConciseState(initialState);
  
  return (
    <>
      <div
        onClick={() => {
          setState({
             count: count + 1,
             text: "ASD",
          });
          // or
          // store.setState({
          //   count: count + 1,
          //   text: "ASD",
          // });
          // store has all the data of useConciseState
          // and the restore, syncUpdate, and subscribe methods
        }}
      >
        {count}
      </div>
      <div>{text}</div>
    </>
  );
}
```

restore„ÄÅsyncUpdate„ÄÅsubscribe these api can also be deconstructed and used directly.
```tsx
import { useEffect } from "react";
import { useConciseState } from "resy";

function App() {
  const { count, text, restore, syncUpdate, subscribe } = useConciseState(initialState);
  
  useEffect(() => {
    return subscribe(({ effectState }) => {
      console.log(effectState);
    }, ["text"]);
  }, []);
  
  return (
    <>
      <input
        value={text}
        onChange={(event: React.ChangeEvent<HTMLInputElement>) => {
          syncUpdate({text: event.target.value});
        }}
      />
      <div onClick={() => restore()}>reset-btn</div>
      <div>{text}</div>
    </>
  );
}
```
</details>

<details>
<summary>subscribe</summary>

#### global subscribe
```tsx
// You can also subscribe to a non-lifecycle data monitor directly.
const unsub = store.subscribe(() => {
  // ... to do anything
}, ["count", "text"]);

// cancel subscirbe
// unsub();
```

#### empty keys
<details>
<summary>empty state keys</summary>
You can also not add an array of monitoring subscription data keys,
Both empty keys and no keys mean listening subscriptions to changes in the entire store data.
</details>

```tsx
store.subscribe(() => {
  // ... to do anything
}, []);
// [] or no state keys is equal
// no state keys
store.subscribe(() => {
  // ... to do anything
});
```

#### general use
```tsx
import { useEffect } from "react";
import { useStore } from "resy";

function App() {
  const { count } = useStore(store);
  
  // Here is an example of a function component.
  // If it is a class component, it can be used in componentDidMount.
  useEffect(() => {
    /**
     * @param listener: subscription monitoring callback function
     * @param stateKeys: subscription listens for changes in certain data fields of a specific store.
     * If empty, default listens for changes in any one of the data in store.
     * @return Unsubscribe: unsubscribe to the function of listening
     */
    const unsubscribe = store.subscribe(({
      effectState, prevState, nextState,
    }) => {
      /**
       * effectStateÔºöCurrently changing data
       *   nextStateÔºöData after change
       *   prevStateÔºöData before change
       */
      console.log(effectState, prevState, nextState);
    }, ["count", "text"]);
    
    // unsubscribe();
    return () => {
      unsubscribe();
      // ... to do else anything
    };
  }, []);
  
  function btnClickA() {
    store.count++;
  }
	
  function btnClickB() {
    store.text = "control btn-b click update text state value";
  }
	
  function btnClickC() {
    store.setState({
      count: count + 1,
      text: "control btn-c click update text state value",
    });
  }
  
  return (
    <>
      <p>{count}</p>
      <button onClick={btnClickA}>btn-A</button><br/>
      <button onClick={btnClickB}>btn-B</button><br/>
      <button onClick={btnClickC}>btn-C</button>
    </>
  );
}
```
</details>

<details>
<summary>restore</summary>

```tsx
import { useStore } from "resy";

function App() {
  const { count, text } = useStore(store);
  
  return (
    <>
      <div>{count}-{text}</div>
      <div onClick={() => {
        // data recover initial
        store.restore();
      }}>reset-btn</div>
    </>
  );
}
```

```tsx
import { createStore, useStore } from "resy";

const timeStore = createStore(() => {
  return {
    now: Date.now(),
  };
});

function App() {
  const { now } = useStore(timeStore);
  
  return (
    <>
      <div>now:{now}</div>
      <div onClick={() => {
        // time data now recover and also changed initial,
        // because of initialState is function return.
        store.restore();
      }}>reset-btn</div>
    </>
  );
}
```
</details>

<details>
<summary>setOptions</summary>

```tsx
function App() {
  return (
    <button onClick={() => {
      // Use less scenes, use it with caution
      // You can change the unmountRestore parameter setting of createStore
      store.setOptions({ unmountRestore: false });
    }}>btn</button>
  );
}
```
</details>

## Deprecated API
| API             | Description                                                  |
|-----------------|--------------------------------------------------------------|
| view            | Help components to automatically process SCU and memo        |

### Detailed introduction of api

<details>
<summary>view</summary>

##### support for class components
```tsx
import React from "react";
import { useStore, MapStateToProps, view } from "resy";

class ClassCom extends React.Component<MapStateToProps<StateType>> {
  render() {
    // The data is hung on the state property of the props of the class component
    const { count, text } = this.props.state;
    return (
      <div>{count}{text}</div>
    );
  }
}

const ClassComView = view(ClassCom, { stores: store });
```

##### view for hook mode I
```tsx
function HookCom() {
  const { count, text } = useStore(store);
  return (
    <div>{count}{text}</div>
  );
}
const HookComView = view(HookCom);
```

* name data update, will not cause TestView re-render
* name data update, will not cause TestView2 re-render
```tsx
function App() {
  const { increase, name } = useStore(store);
  
  return (
    <>
      <Text/>
      <Count/>
      <ClassComView/>
      <HookComView/>
      <div>{name}</div>
      <button onClick={() => { store.name = "app"; }}>btn-name</button>
      <button onClick={increase}>btn+</button>
      <button onClick={() => { store.count-- }}>btn-</button>
    </>
  );
}
```

##### view for hook mode II
```tsx
function HookCom(props: MapStateToProps<StateType>) {
  const { count, text } = props.state;
  return (
    <div>{count}{text}</div>
  );
}
const HookComView2 = view(HookCom, { stores: store });
```

##### for class component
```tsx
import React from "react";
import { useStore, MapStateToProps, view } from "resy";

type ComPropsType = { name: string };

// the second type parameter of the MapStateToProps paradigm type is the type of props.
class ClassComWithProps extends React.Component<
  MapStateToProps<StateType, ComPropsType>
> {
  render() {
    const { state: { count, text }, name } = this.props;
    return (
      <div>{count}{text}{name}</div>
    );
  }
}

// you can add a props type interface to the generic type of view.
const ClassComWithPropsView = view<ComPropsType>(ClassComWithProps, { stores: store });

function App() {
  return (
    <ClassComWithPropsView name="ClassComPropsName"/>
  );
}
```

##### view's equalCompare function handle
```tsx
const ClassComWithPropsEqualView = view<ComPropsType, StateType>(ClassComWithProps, {
  stores: store,
  // if compare is set to true, equivalent to React.memo without propsAreEqual
  // compare: true,
  // if compare is set to a function, it is similar to React.memo's propsAreEqual.
  compare: (next, prev) => {
    const { props: nextProps, state: nextState } = next;
    const { props: prevProps, state: prevState } = prev;
    // some conditon
    if (
      nextProps.name === "ClassComPropsName"
      || prevProps.name === "ClassComPropsName"
    ) {
      return false;
    }
    return (
      nextState.count === prevState.count
      || nextState.text === prevState.text
    );
  },
});
```

##### multiple store for class component
```tsx
import React from "react";

const loginStore = createStore<{ userName: string }>({
   userName: "resy",
});
const themeStore = createStore<{ theme: "light" | "dark" }>({
   theme: "light",
});

type MultipleStateType = {
  loginState: {
    userName: string;
  };
  themeState: {
    theme: "light" | "dark";
  };
};

type ClassComMultipleProps = {
  value: number;
};

class ClassComMultiple extends React.Component<MapStateToProps<
  MultipleStateType,
  ClassComMultipleProps
>> {
  render() {
    const { value } = this.props;
    const { loginState: { userName }, themeState: { theme } } = this.props.state;
    return (
      <div>
        userName{userName}<br/>
        theme:{theme}<br/>
        value:{value}<br/>
      </div>
    );
  }
}

const ClassComMultipleView4 = view<ClassComMultipleProps, MultipleStateType>(
  ClassComMultiple,
  {
    stores: { loginState: loginStore, themeState: themeStore },
    equal: (next, prev) => {
      console.log(next.state.loginState.userName, prev.props.value);
      // if (...) return true;
      return false;
    },
  },
);
```
</details>

### License
[MIT License](https://github.com/lsbFlying/resy/blob/master/LICENSE) (c) [ÂàòÂñÑ‰øù](https://github.com/lsbFlying)

